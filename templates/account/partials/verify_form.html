<!-- این partial بعد از ارسال موفق کد توسط HTMX جایگزین فرم ورود می‌شود -->

<div class="login-logo">
    <div class="logo-icon">
        <i class="fas fa-shield-alt"></i>
    </div>
    <h1 class="logo-text">تایید شماره موبایل</h1>
    <p class="logo-subtitle">
        کد تایید برای شماره
        <strong>{{ phone_display }}</strong>
        ارسال شد
    </p>
</div>

<div class="login-form">
    <div class="form-header">
        <h2 class="form-title">کد تایید را وارد کنید</h2>
        <p class="form-description">کد ۵ رقمی ارسال شده به موبایل خود را وارد نمایید</p>
    </div>

    <div class="form-body">
        <!-- OTP Inputs -->
        <div class="verification-code-container" id="otp-container">
            <input type="text" class="code-input" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="one-time-code">
            <input type="text" class="code-input" maxlength="1" inputmode="numeric" pattern="[0-9]">
            <input type="text" class="code-input" maxlength="1" inputmode="numeric" pattern="[0-9]">
            <input type="text" class="code-input" maxlength="1" inputmode="numeric" pattern="[0-9]">
            <input type="text" class="code-input" maxlength="1" inputmode="numeric" pattern="[0-9]">
        </div>

        <!-- خطا -->
        <div id="otp-error-container" style="min-height:24px; text-align:center; margin-bottom:8px"></div>

        <!-- Resend Timer -->
        <div class="resend-section">
            <p class="resend-text" id="resendText">
                <span class="timer" id="timer">۰۲:۰۰</span>
            </p>

            <button class="resend-btn"
                    id="resendBtn"
                    disabled
                    hx-post="/resend-code/"
                    hx-target="#resend-result"
                    hx-swap="innerHTML"
                    hx-on::after-request="resetTimer()"
                    type="button">
                <i class="fas fa-redo"></i>
                ارسال مجدد کد
            </button>
            <div id="resend-result" style="margin-top:8px; font-size:13px; text-align:center"></div>
        </div>

        <!-- Verify Button -->
        <form hx-post="/verify-code/"
              hx-target="#otp-error-container"
              hx-swap="innerHTML"
              id="verify-form">
            {% csrf_token %}
            <input type="hidden" name="code" id="otp-hidden-input">

            <button class="btn btn-primary btn-large" id="verifyBtn" type="submit" disabled>
                <span>تایید و ادامه</span>
                <i class="fas fa-check" id="verify-icon"></i>
                <i class="fas fa-spinner fa-spin" id="verify-spinner" style="display:none"></i>
            </button>
        </form>

        <button class="btn btn-secondary btn-large"
                type="button"
                onclick="window.location.href='/login/'">
            <i class="fas fa-edit"></i>
            <span>تغییر شماره موبایل</span>
        </button>
    </div>
</div>

<div class="security-notice">
    <i class="fas fa-lock"></i>
    <p>این کد محرمانه است و هرگز آن را با دیگران به اشتراک نگذارید.</p>
</div>

<script>
(function() {
    // ─── OTP Input Logic ───
    const inputs = document.querySelectorAll('.code-input');
    const verifyBtn = document.getElementById('verifyBtn');
    const hiddenInput = document.getElementById('otp-hidden-input');

    function getCode() {
        return Array.from(inputs).map(i => i.value).join('');
    }

    function updateVerifyBtn() {
        const code = getCode();
        verifyBtn.disabled = code.length !== 5;
        hiddenInput.value = code;
    }

    inputs.forEach((input, idx) => {
        input.addEventListener('input', e => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(-1);
            if (e.target.value) {
                e.target.classList.add('filled');
                if (idx < inputs.length - 1) inputs[idx + 1].focus();
            } else {
                e.target.classList.remove('filled');
            }
            updateVerifyBtn();
        });

        input.addEventListener('keydown', e => {
            if (e.key === 'Backspace' && !e.target.value && idx > 0) {
                inputs[idx - 1].value = '';
                inputs[idx - 1].classList.remove('filled');
                inputs[idx - 1].focus();
                updateVerifyBtn();
            }
        });

        input.addEventListener('paste', e => {
            e.preventDefault();
            const pasted = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 5);
            pasted.split('').forEach((ch, i) => {
                if (inputs[i]) {
                    inputs[i].value = ch;
                    inputs[i].classList.add('filled');
                }
            });
            if (pasted.length === 5) inputs[4].focus();
            updateVerifyBtn();
        });
    });

    // Focus اولین input
    setTimeout(() => inputs[0]?.focus(), 50);

    // نمایش spinner هنگام verify
    document.getElementById('verify-form').addEventListener('htmx:beforeRequest', () => {
        document.getElementById('verify-icon').style.display = 'none';
        document.getElementById('verify-spinner').style.display = 'inline-block';
        verifyBtn.disabled = true;
    });

    document.getElementById('verify-form').addEventListener('htmx:afterRequest', (e) => {
        document.getElementById('verify-icon').style.display = 'inline-block';
        document.getElementById('verify-spinner').style.display = 'none';
        if (e.detail.xhr.status !== 204) {
            // کد اشتباه: لرزش و پاک کردن
            inputs.forEach(i => { i.classList.add('error'); i.value = ''; i.classList.remove('filled'); });
            setTimeout(() => inputs.forEach(i => i.classList.remove('error')), 400);
            inputs[0].focus();
            hiddenInput.value = '';
            verifyBtn.disabled = true;
        }
    });

    // ─── Countdown Timer ───
    let timeLeft = 120;
    let timerInterval;
    const persianDigits = ['۰','۱','۲','۳','۴','۵','۶','۷','۸','۹'];

    function toPersian(str) {
        return str.replace(/\d/g, d => persianDigits[parseInt(d)]);
    }

    function updateTimer() {
        const min = Math.floor(Math.max(0, timeLeft) / 60);
        const sec = Math.max(0, timeLeft) % 60;
        const el = document.getElementById('timer');
        if (el) el.textContent = toPersian(String(min).padStart(2,'0') + ':' + String(sec).padStart(2,'0'));
    }

    function startTimer() {
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimer();
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                document.getElementById('resendBtn').disabled = false;
                const rt = document.getElementById('resendText');
                if (rt) rt.innerHTML = '<span style="color:var(--danger)">زمان اعتبار کد به پایان رسید</span>';
            }
        }, 1000);
    }

    // expose for reset after resend
    window.resetTimer = function() {
        timeLeft = 120;
        document.getElementById('resendBtn').disabled = true;
        const rt = document.getElementById('resendText');
        if (rt) rt.innerHTML = '<span class="timer" id="timer"></span>';
        startTimer();
    };

    updateTimer();
    startTimer();
})();
</script>