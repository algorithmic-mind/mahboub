<div class="modal-overlay" id="editProfileModal" onclick="closeModal(event, 'editProfileModal')">
    <div class="modal-box modal-box--large">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-user-edit"></i>
                ویرایش پروفایل
            </h3>
            <button class="modal-close" onclick="closeModalById('editProfileModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form hx-post="{% url 'profile_update' %}"
              hx-target="#edit-modal-container"
              hx-swap="innerHTML"
              hx-on::after-request="onProfileSaved(event)"
              id="editProfileForm">
            {% csrf_token %}

            <div class="modal-body">
                <!-- آواتار -->
                <div class="edit-avatar">
                    <div class="profile-avatar profile-avatar--sm">
                        <i class="fas fa-user"></i>
                    </div>
                </div>

                <!-- نام -->
                <div class="form-row">
                    <div class="field-group {% if errors.first_name %}has-error{% endif %}">
                        <label class="field-label">
                            <i class="fas fa-user"></i> نام
                        </label>
                        <input type="text"
                               name="first_name"
                               class="field-input"
                               value="{{ form.first_name|default:user.first_name }}"
                               placeholder="نام خود را وارد کنید"
                               maxlength="50">
                        {% if errors.first_name %}
                            <span class="field-error">{{ errors.first_name }}</span>
                        {% endif %}
                    </div>

                    <div class="field-group {% if errors.last_name %}has-error{% endif %}">
                        <label class="field-label">
                            <i class="fas fa-user"></i> نام خانوادگی
                        </label>
                        <input type="text"
                               name="last_name"
                               class="field-input"
                               value="{{ form.last_name|default:user.last_name }}"
                               placeholder="نام خانوادگی خود را وارد کنید"
                               maxlength="50">
                        {% if errors.last_name %}
                            <span class="field-error">{{ errors.last_name }}</span>
                        {% endif %}
                    </div>
                </div>

                <!-- ایمیل -->
                <div class="field-group {% if errors.email %}has-error{% endif %}">
                    <label class="field-label">
                        <i class="fas fa-envelope"></i> ایمیل
                    </label>
                    <input type="email"
                           name="email"
                           class="field-input"
                           dir="ltr"
                           value="{{ form.email|default:user.email }}"
                           placeholder="example@email.com"
                           inputmode="email">
                    {% if errors.email %}
                        <span class="field-error">{{ errors.email }}</span>
                    {% endif %}
                </div>

                <!-- شماره موبایل (فقط نمایش) -->
                <div class="field-group">
                    <label class="field-label">
                        <i class="fas fa-mobile-alt"></i> شماره موبایل
                    </label>
                    <div class="field-input field-input--readonly" dir="ltr">
                        {{ user.phone_number }}
                        <span class="field-badge">تغییر از طریق پشتیبانی</span>
                    </div>
                </div>
            </div>

            <div class="modal-actions modal-actions--border">
                <button type="button" class="btn btn-ghost" onclick="closeModalById('editProfileModal')">
                    انصراف
                </button>
                <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                    <i class="fas fa-check" id="save-icon"></i>
                    <i class="fas fa-spinner fa-spin" id="save-spinner" style="display:none"></i>
                    <span>ذخیره تغییرات</span>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// نمایش spinner هنگام submit
document.getElementById('editProfileForm').addEventListener('htmx:beforeRequest', function() {
    document.getElementById('save-icon').style.display = 'none';
    document.getElementById('save-spinner').style.display = 'inline-block';
    document.getElementById('saveProfileBtn').disabled = true;
});

document.getElementById('editProfileForm').addEventListener('htmx:afterRequest', function() {
    document.getElementById('save-icon').style.display = 'inline-block';
    document.getElementById('save-spinner').style.display = 'none';
    document.getElementById('saveProfileBtn').disabled = false;
});

function onProfileSaved(event) {
    // اگر 204 → ذخیره موفق بود، modal را ببند و پروفایل را آپدیت کن
    if (event.detail.xhr.status === 204) {
        closeModalById('editProfileModal');
    }
}
</script>
