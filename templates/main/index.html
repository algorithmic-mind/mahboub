{% extends 'base.html' %}
{% load static %}

{% block title %}{{ site_settings.site_name|default:"سامانه جامع محبوب" }}{% endblock %}

{% block extra_css %}
<!-- Add htmx library -->
<script src="https://unpkg.com/htmx.org@2.0.0-beta3/dist/htmx.js"></script>

{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Simple Image Slider (matching old.html) -->
    <div class="simple-slider" id="imageSlider"
         data-autoplay="{{ slider.auto_play|yesno:'true,false' }}"
         data-interval="{{ slider.interval|default:4000 }}">
        <div class="slider-container">
            {% if slides %}
                {% for slide in slides %}
                <a href="{{ slide.link|default:'#' }}" class="slider-slide {% if forloop.first %}active{% endif %}">
                    <img src="{{ slide.image.url }}" alt="{{ slide.title|default:'اسلاید' }}" class="slider-image">
                </a>
                {% endfor %}
            {% else %}
                <a href="#" class="slider-slide active">
                    <img src="{% static 'imgs/1.jpg' %}" alt="اسلاید" class="slider-image">
                </a>
            {% endif %}
        </div>

        <div class="slider-dots">
            {% if slides %}
                {% for slide in slides %}
                <button class="slider-dot {% if forloop.first %}active{% endif %}" data-slide="{{ forloop.counter0 }}"></button>
                {% endfor %}
            {% else %}
                <button class="slider-dot active" data-slide="0"></button>
            {% endif %}
        </div>

        <button class="slider-arrow slider-prev">
            <i class="fas fa-chevron-right"></i>
        </button>
        <button class="slider-arrow slider-next">
            <i class="fas fa-chevron-left"></i>
        </button>
    </div>

    <!-- Categories Section - 8 items (matching old.html) -->
    <div class="section-title">دسترسی سریع</div>
    <div class="categories-grid">
        <a href="{% url 'books:books_list' %}" class="card category-item slide-up" style="animation-delay: 0ms;">
            <div class="card-body" style="padding: 12px 6px;">
                <i class="fas fa-book"></i>
                <div class="category-title">کتابخانه</div>
                <div class="category-count">۱۸۵ کتاب</div>
            </div>
        </a>
        <a href="#" class="card category-item slide-up" style="animation-delay: 50ms;">
            <div class="card-body" style="padding: 12px 6px;">
                <i class="fas fa-microphone"></i>
                <div class="category-title">صوت</div>
                <div class="category-count">۳۲۴ صوت</div>
            </div>
        </a>
        <a href="#" class="card category-item slide-up" style="animation-delay: 100ms;">
            <div class="card-body" style="padding: 12px 6px;">
                <i class="fas fa-video"></i>
                <div class="category-title">نگاره</div>
                <div class="category-count">۱۲۸ نگاره</div>
            </div>
        </a>
        <a href="#" class="card category-item slide-up" style="animation-delay: 150ms;">
            <div class="card-body" style="padding: 12px 6px;">
                <i class="fas fa-robot"></i>
                <div class="category-title">هوش مصنوعی</div>
                <div class="category-count">جدید</div>
            </div>
        </a>
        <a href="#" class="card category-item slide-up" style="animation-delay: 200ms;">
            <div class="card-body" style="padding: 12px 6px;">
                <i class="fas fa-book-quran"></i>
                <div class="category-title">استخاره</div>
                <div class="category-count">آنلاین</div>
            </div>
        </a>
        <a href="#" class="card category-item slide-up" style="animation-delay: 250ms;">
            <div class="card-body" style="padding: 12px 6px;">
                <i class="fas fa-hands-praying"></i>
                <div class="category-title">دعا</div>
                <div class="category-count">۲۵۰ دعا</div>
            </div>
        </a>
        <a href="#" class="card category-item slide-up" style="animation-delay: 300ms;">
            <div class="card-body" style="padding: 12px 6px;">
                <i class="fas fa-mosque"></i>
                <div class="category-title">اوقات شرعی</div>
                <div class="category-count">۵۰ شهر</div>
            </div>
        </a>
        <a href="#" class="card category-item slide-up" style="animation-delay: 350ms;">
            <div class="card-body" style="padding: 12px 6px;">
                <i class="fas fa-calendar-alt"></i>
                <div class="category-title">مناسبت‌ها</div>
                <div class="category-count">تقویم</div>
            </div>
        </a>
    </div>

    <!-- Books Section with Dynamic Tabs and Scrollable Row (matching old.html structure) -->
    <div class="content-box">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-book"></i>
                کتاب‌های پیشنهادی
            </div>
            <a href="{% url 'books:books_list' %}" class="view-all">
                مشاهده همه
                <i class="fas fa-chevron-left"></i>
            </a>
        </div>
        
        <div class="category-tabs" id="categoryTabsIndex">
            <button class="category-tab active" data-category="all"
                    hx-get="{% url 'main:ajax_books' %}?category=all"
                    hx-target="#booksRowIndex"
                    hx-swap="innerHTML"
                    onclick="setActiveTab(this)">همه کتاب‌ها</button>
            {% for category in book_categories %}
            <button class="category-tab" data-category="{{ category.slug }}"
                    hx-get="{% url 'main:ajax_books' %}?category={{ category.slug }}"
                    hx-target="#booksRowIndex"
                    hx-swap="innerHTML"
                    onclick="setActiveTab(this)">{{ category.name }}</button>
            {% endfor %}
        </div>

        <div class="books-row" id="booksRowIndex">
            {% if featured_books %}
                {% for book in featured_books %}
                <a href="{% url 'books:book_detail' book.slug %}" class="book-item">
                    <img src="{{ book.cover_image.url|default:'/static/imgs/default-book.jpg' }}" alt="{{ book.title }}" class="book-cover">
                    <div class="book-info">
                        <div class="book-title">{{ book.title|truncatechars:30 }}</div>
                        <div class="book-author">{{ book.author|truncatechars:20 }}</div>
                        <div class="book-rating">
                            <i class="fas fa-star"></i> {{ book.rating }}
                        </div>
                        {% if book.access_type == 'free' %}
                        <div class="book-price">رایگان</div>
                        {% elif book.discount_percent > 0 %}
                        <div class="book-price">{{ book.final_price }} تومان <span class="discount">{{ book.price }} تومان</span></div>
                        {% else %}
                        <div class="book-price">{{ book.price }} تومان</div>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <p style="text-align: center; width: 100%; color: var(--text-secondary);">هیچ کتاب پیشنهادی موجود نیست.</p>
            {% endif %}
        </div>
    </div>

    <!-- Podcasts Section matching old.html -->
    <div class="content-box">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-microphone"></i>
                صوت‌های پیشنهادی
            </div>
            <a href="#" class="view-all">
                مشاهده همه
                <i class="fas fa-chevron-left"></i>
            </a>
        </div>
        
        <div class="category-tabs" id="podcastTabsIndex">
            <button class="category-tab active" data-category="all"
                    hx-get="{% url 'main:ajax_podcasts' %}?category=all"
                    hx-target="#podcastsRowIndex"
                    hx-swap="innerHTML"
                    onclick="setActiveTab(this)">همه صوت‌ها</button>
            {% for category in podcast_categories %}
            <button class="category-tab" data-category="{{ category.slug }}"
                    hx-get="{% url 'main:ajax_podcasts' %}?category={{ category.slug }}"
                    hx-target="#podcastsRowIndex"
                    hx-swap="innerHTML"
                    onclick="setActiveTab(this)">{{ category.name }}</button>
            {% endfor %}
        </div>

        <div class="podcasts-row" id="podcastsRowIndex">
            {% if featured_podcasts %}
                {% for podcast in featured_podcasts %}
                <a href="{% url 'podcasts:podcast_detail' podcast.slug %}" class="podcast-item">
                    <img src="{{ podcast.cover_image.url|default:'/static/imgs/default-podcast.jpg' }}" alt="{{ podcast.title }}" class="podcast-cover">
                    <div class="podcast-info">
                        <div class="podcast-title">{{ podcast.title|truncatechars:30 }}</div>
                        <div class="podcast-host">{{ podcast.host|truncatechars:20 }}</div>
                        <div class="podcast-duration">{{ podcast.duration_display }}</div>
                        <div class="podcast-rating">
                            <i class="fas fa-star"></i> {{ podcast.rating }}
                        </div>
                        {% if podcast.access_type == 'free' %}
                        <div class="podcast-price">رایگان</div>
                        {% elif podcast.discount_percent > 0 %}
                        <div class="podcast-price">{{ podcast.final_price }} تومان <span class="discount">{{ podcast.price }} تومان</span></div>
                        {% else %}
                        <div class="podcast-price">{{ podcast.price }} تومان</div>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <p style="text-align: center; width: 100%; color: var(--text-secondary);">هیچ صوت پیشنهادی موجود نیست.</p>
            {% endif %}
        </div>
    </div>

    <!-- Courses Section matching old.html -->
    <div class="content-box">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-video"></i>
                نگاره‌های پیشنهادی
            </div>
            <a href="" class="view-all">
                مشاهده همه
                <i class="fas fa-chevron-left"></i>
            </a>
        </div>
        
        <div class="category-tabs" id="courseTabsIndex">
            <button class="category-tab active" data-category="all"
                    hx-get="{% url 'main:ajax_courses' %}?category=all"
                    hx-target="#coursesRowIndex"
                    hx-swap="innerHTML"
                    onclick="setActiveTab(this)">همه نگاره‌ها</button>
            {% for category in course_categories %}
            <button class="category-tab" data-category="{{ category.slug }}"
                    hx-get="{% url 'main:ajax_courses' %}?category={{ category.slug }}"
                    hx-target="#coursesRowIndex"
                    hx-swap="innerHTML"
                    onclick="setActiveTab(this)">{{ category.name }}</button>
            {% endfor %}
        </div>

        <div class="courses-row" id="coursesRowIndex">
            {% if featured_courses %}
                {% for course in featured_courses %}
                <a href="{% url 'courses:course_detail' course.slug %}" class="course-item">
                    <img src="{{ course.cover_image.url|default:'/static/imgs/default-course.jpg' }}" alt="{{ course.title }}" class="course-cover">
                    <div class="course-info">
                        <div class="course-title">{{ course.title|truncatechars:30 }}</div>
                        <div class="course-instructor">{{ course.instructor|truncatechars:20 }}</div>
                        <div class="course-duration">{{ course.duration_display }}</div>
                        <div class="course-rating">
                            <i class="fas fa-star"></i> {{ course.rating }}
                        </div>
                        {% if course.access_type == 'free' %}
                        <div class="course-price">رایگان</div>
                        {% elif course.discount_percent > 0 %}
                        <div class="course-price">{{ course.final_price }} تومان <span class="discount">{{ course.price }} تومان</span></div>
                        {% else %}
                        <div class="course-price">{{ course.price }} تومان</div>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <p style="text-align: center; width: 100%; color: var(--text-secondary);">هیچ نگاره پیشنهادی موجود نیست.</p>
            {% endif %}
        </div>
    </div>

    <!-- Banners Section (Dynamic) -->
    {% if banners %}
    <div class="banners-section">
        {% for banner in banners %}
        <a href="{{ banner.link|default:'#' }}" class="banner-item">
            <img src="{{ banner.image.url }}" alt="{{ banner.title }}" class="banner-image">
        </a>
        {% endfor %}
    </div>
    {% endif %}

    <!-- آیه روز (matching old.html) -->
    <div class="section-title">
        <i class="fas fa-quran"></i>
        آیه روز
    </div>
    <div class="card quran-verse-card">
        <div class="card-body">
            <div style="font-size: 16px; font-weight: 600; text-align: justify;">
                "مَنْ عَمِلَ صَالِحًا فَلِنَفْسِهِ ۖ وَمَنْ أَسَاءَ فَعَلَيْهَا"
            </div>
            <div style="font-size: 12px; opacity: 0.9; margin-bottom: 10px;">
                هر کس کار شایسته‌‌ای کند، به سود خود اوست و هر کس بدی کند، به زیان خود اوست
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; font-size: 11px;">
                <span>سوره فصلت - آیه ۴۶</span>
                <button class="btn btn-sm" style="background: rgba(255,255,255,0.2); color: white;">
                    <i class="fas fa-share-alt"></i> اشتراک
                </button>
            </div>
        </div>
    </div>
<br>

    <!-- نماد ها و مجوز ها (matching old.html) -->
    <div class="section-title">
        <i class="fas fa-shield-alt"></i>
        نماد ها و مجوز ها
    </div>
    <div class="card" style="margin-bottom: 16px;">
        <div class="card-body" style="padding: 16px;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                <div style="text-align: center; padding: 10px; background: var(--gray-50); border-radius: var(--radius); border: 1px solid var(--gray-200);">
                    <div style="width: 50px; height: 50px; margin: 0 auto 6px; background: linear-gradient(135deg, #4caf50, #2e7d32); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-shield-alt" style="font-size: 24px; color: white;"></i>
                    </div>
                    <div style="font-size: 11px; font-weight: 600; color: var(--text-primary); margin-bottom: 3px;">نماد اعتماد الکترونیکی</div>
                    <div style="font-size: 9px; color: var(--text-secondary);">دارای مجوز رسمی</div>
                </div>

                <div style="text-align: center; padding: 10px; background: var(--gray-50); border-radius: var(--radius); border: 1px solid var(--gray-200);">
                    <div style="width: 50px; height: 50px; margin: 0 auto 6px; background: linear-gradient(135deg, #2196f3, #1565c0); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-certificate" style="font-size: 24px; color: white;"></i>
                    </div>
                    <div style="font-size: 11px; font-weight: 600; color: var(--text-primary); margin-bottom: 3px;">ساماندهی کسب‌وکار</div>
                    <div style="font-size: 9px; color: var(--text-secondary);">ثبت شده در سامانه</div>
                </div>

                <div style="text-align: center; padding: 10px; background: var(--gray-50); border-radius: var(--radius); border: 1px solid var(--gray-200);">
                    <div style="width: 50px; height: 50px; margin: 0 auto 6px; background: linear-gradient(135deg, #ff9800, #ef6c00); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-credit-card" style="font-size: 24px; color: white;"></i>
                    </div>
                    <div style="font-size: 11px; font-weight: 600; color: var(--text-primary); margin-bottom: 3px;">پرداخت امن</div>
                    <div style="font-size: 9px; color: var(--text-secondary);">درگاه معتبر بانکی</div>
                </div>

                <div style="text-align: center; padding: 10px; background: var(--gray-50); border-radius: var(--radius); border: 1px solid var(--gray-200);">
                    <div style="width: 50px; height: 50px; margin: 0 auto 6px; background: linear-gradient(135deg, #9c27b0, #6a1b9a); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-book-reader" style="font-size: 24px; color: white;"></i>
                    </div>
                    <div style="font-size: 11px; font-weight: 600; color: var(--text-primary); margin-bottom: 3px;">مجوز نشر دیجیتال</div>
                    <div style="font-size: 9px; color: var(--text-secondary);">وزارت فرهنگ و ارشاد</div>
                </div>
            </div>
            
            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--gray-200); text-align: center;">
                <p style="font-size: 11px; color: var(--text-secondary); line-height: 1.5;">
                    تمامی محتوای این سایت دارای مجوز های لازم بوده و استفاده از آن با رعایت قوانین کپی رایت مجاز می باشد.
                </p>
            </div>
        </div>
    </div>
</div>
{% if site_settings.maintenance_mode %}
<div style="position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.88); display:flex; align-items:center; justify-content:center; padding:24px;">
    <div style="background:var(--card-bg,#fff); border-radius:var(--radius,12px); padding:32px; text-align:center; max-width:340px;text-align: center;align-items: center;justify-content: center;">
        <i class="fas fa-tools" style="font-size:48px; color:var(--primary,#f65b5b); margin-bottom:16px; display:block;"></i>
        <h2 style="margin-bottom:12px; font-size:18px;">در حال به‌روزرسانی</h2>
        <p style="font-size:14px; color:var(--text-secondary); line-height:1.7;">{{ site_settings.maintenance_message }}</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if site_settings.footer_scripts %}{{ site_settings.footer_scripts|safe }}{% endif %}
<script>
const sliderEl = document.getElementById('imageSlider');
if (sliderEl && sliderEl.dataset.autoplay) {
    window.__sliderAutoPlay = sliderEl.dataset.autoplay === 'true';
    window.__sliderInterval = parseInt(sliderEl.dataset.interval) || 4000;
}

// Function to set active tab (matching old.html JS if any)
function setActiveTab(button) {
    const tabs = button.parentElement.querySelectorAll('.category-tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    button.classList.add('active');
}
</script>
{% endblock %}