{% load static %}

{% if grouped_books %}
    {% for cat, books in grouped_books.items %}
    <section class="book-category">
        <div class="section-header">
            <div class="section-title">
                {% if cat.icon %}<i class="{{ cat.icon }}"></i>{% endif %}
                {{ cat.name }}
            </div>
            <a href="{% url 'book:books_by_category' cat.slug %}" class="view-all">
                مشاهده همه
                <i class="fas fa-chevron-left"></i>
            </a>
        </div>
        <div class="books-scroll">
            {% for book in books %}
            <a href="{% url 'book:book_detail' book.slug %}" class="book-card">
                <div class="book-cover">
                    {% if book.cover_image %}
                    <div class="book-image" style="background:#f5f5f5;">
                        <img src="{{ book.cover_image.url }}"
                             alt="{{ book.title }}"
                             style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">
                    </div>
                    {% else %}
                    <div class="book-image" style="background: {{ book|book_gradient }};">
                        <i class="fas fa-book-open"></i>
                    </div>
                    {% endif %}

                    {# Badge #}
                    {% if book.is_featured %}
                        <span class="book-badge">ویژه</span>
                    {% elif book.access_type == 'free' %}
                        <span class="book-badge free">رایگان</span>
                    {% endif %}
                </div>

                <div class="book-info">
                    <h3 class="book-title">{{ book.title }}</h3>
                    <p class="book-author">{{ book.author }}</p>
                    <div class="book-meta">
                        <span class="book-pages">
                            <i class="fas fa-file-alt"></i>
                            {{ book.total_pages }} صفحه
                        </span>
                        <span class="book-rating">
                            <i class="fas fa-star"></i>
                            {{ book.rating }}
                        </span>
                    </div>
                    <div class="book-price {% if book.access_type == 'free' %}free{% endif %}">
                        {% if book.access_type == 'free' %}
                            رایگان
                        {% elif book.discount_percent %}
                            <span style="text-decoration:line-through;font-size:10px;opacity:.6;">
                                {{ book.price|floatformat:0 }}
                            </span>
                            {{ book.final_price|floatformat:0 }} تومان
                        {% else %}
                            {{ book.price|floatformat:0 }} تومان
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endfor %}

{% elif flat_books %}
    {# حالت جستجو / فیلتر — نمایش صاف بدون گروه‌بندی #}
    <section class="book-category">
        <div class="books-scroll">
            {% for book in flat_books %}
            <a href="{% url 'book:book_detail' book.slug %}" class="book-card">
                <div class="book-cover">
                    {% if book.cover_image %}
                    <div class="book-image" style="background:#f5f5f5;">
                        <img src="{{ book.cover_image.url }}"
                             alt="{{ book.title }}"
                             style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">
                    </div>
                    {% else %}
                    <div class="book-image" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <i class="fas fa-book-open"></i>
                    </div>
                    {% endif %}

                    {% if book.is_featured %}
                        <span class="book-badge">ویژه</span>
                    {% elif book.access_type == 'free' %}
                        <span class="book-badge free">رایگان</span>
                    {% endif %}
                </div>

                <div class="book-info">
                    <h3 class="book-title">{{ book.title }}</h3>
                    <p class="book-author">{{ book.author }}</p>
                    <div class="book-meta">
                        <span class="book-pages">
                            <i class="fas fa-file-alt"></i>
                            {{ book.total_pages }} صفحه
                        </span>
                        <span class="book-rating">
                            <i class="fas fa-star"></i>
                            {{ book.rating }}
                        </span>
                    </div>
                    <div class="book-price {% if book.access_type == 'free' %}free{% endif %}">
                        {% if book.access_type == 'free' %}
                            رایگان
                        {% elif book.discount_percent %}
                            <span style="text-decoration:line-through;font-size:10px;opacity:.6;">
                                {{ book.price|floatformat:0 }}
                            </span>
                            {{ book.final_price|floatformat:0 }} تومان
                        {% else %}
                            {{ book.price|floatformat:0 }} تومان
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>

    {# Pagination #}
    {% if flat_books.has_other_pages %}
    <div class="pagination-bar" style="display:flex;justify-content:center;gap:8px;padding:16px 0;">
        {% if flat_books.has_previous %}
        <button class="btn btn-sm"
                hx-get="{% url 'book:books_partial' %}?page={{ flat_books.previous_page_number }}"
                hx-target="#books-container"
                hx-include="#filter-form">
            <i class="fas fa-chevron-right"></i>
        </button>
        {% endif %}

        <span style="font-size:13px;padding:6px 12px;background:var(--card-bg);border-radius:var(--radius);">
            صفحه {{ flat_books.number }} از {{ flat_books.paginator.num_pages }}
        </span>

        {% if flat_books.has_next %}
        <button class="btn btn-sm"
                hx-get="{% url 'book:books_partial' %}?page={{ flat_books.next_page_number }}"
                hx-target="#books-container"
                hx-include="#filter-form">
            <i class="fas fa-chevron-left"></i>
        </button>
        {% endif %}
    </div>
    {% endif %}

{% else %}
    <div style="text-align:center;padding:48px 16px;color:var(--text-secondary);">
        <i class="fas fa-search" style="font-size:40px;margin-bottom:12px;display:block;opacity:.4;"></i>
        <p>کتابی یافت نشد.</p>
    </div>
{% endif %}