{% extends 'base.html' %}
{% load static %}

{% block title %}{{ category.name }} — کتابخانه محبوب{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/books.css' %}">
{% endblock %}

{% block content %}

<div class="page-header">
    <a href="{% url 'books:books_list' %}" class="back-btn">
        <i class="fas fa-chevron-right"></i>
        کتابخانه
    </a>
    <h1 class="page-title">
        {% if category.icon %}<i class="{{ category.icon }}"></i>{% else %}<i class="fas fa-book-open"></i>{% endif %}
        {{ category.name }}
    </h1>
    <p class="page-subtitle">{{ page_obj.paginator.count }} کتاب در این دسته‌بندی</p>
</div>

<!-- Filter Bar -->
<form method="get" id="filter-form" class="filter-bar">
    <div class="filter-scroll">
        <div class="filter-search-wrap">
            <input type="text" name="q" value="{{ search_query }}"
                   placeholder="جستجو..." class="filter-search-input">
            <button type="submit" class="filter-search-btn">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <select name="access" class="filter-select" onchange="this.form.submit()">
            <option value="">همه</option>
            <option value="free"    {% if selected_access == 'free'    %}selected{% endif %}>رایگان</option>
            <option value="paid"    {% if selected_access == 'paid'    %}selected{% endif %}>پولی</option>
            <option value="premium" {% if selected_access == 'premium' %}selected{% endif %}>اشتراکی</option>
        </select>
        <select name="sort" class="filter-select" onchange="this.form.submit()">
            <option value="-created_at" {% if selected_sort == '-created_at' %}selected{% endif %}>جدیدترین</option>
            <option value="-views"      {% if selected_sort == '-views'      %}selected{% endif %}>پربازدیدترین</option>
            <option value="-rating"     {% if selected_sort == '-rating'     %}selected{% endif %}>بهترین امتیاز</option>
            <option value="price"       {% if selected_sort == 'price'       %}selected{% endif %}>ارزان‌ترین</option>
            <option value="-price"      {% if selected_sort == '-price'      %}selected{% endif %}>گران‌ترین</option>
        </select>
    </div>
</form>

<!-- Books Grid -->
{% if books %}
<div class="books-grid">
    {% for book in books %}
    <a href="{% url 'books:book_detail' book.slug %}" class="book-item">

        {% if book.cover_image %}
        <img src="{{ book.cover_image.url }}" alt="{{ book.title }}" class="book-cover-img">
        {% else %}
        <div class="book-cover-placeholder" style="background:{{ book.gradient }};">
            <i class="fas fa-{{ book.cover_icon }}"></i>
            {% if book.is_featured %}
                <span class="book-badge">پرفروش</span>
            {% elif book.access_type == 'free' %}
                <span class="book-badge free">رایگان</span>
            {% endif %}
        </div>
        {% endif %}

        <div class="book-info">
            <div class="book-title">{{ book.title|truncatechars:24 }}</div>
            <div class="book-author">{{ book.author|truncatechars:16 }}</div>
            <div class="book-rating"><i class="fas fa-star"></i> {{ book.rating }}</div>
            {% if book.access_type == 'free' %}
            <div class="book-price">رایگان</div>
            {% elif book.discount_percent > 0 %}
            <div class="book-price">
                {{ book.final_price|floatformat:0 }} تومان
                <span class="discount">{{ book.price|floatformat:0 }}</span>
            </div>
            {% else %}
            <div class="book-price">{{ book.price|floatformat:0 }} تومان</div>
            {% endif %}
        </div>

    </a>
    {% endfor %}
</div>

{% if page_obj.has_other_pages %}
<div class="pagination-bar">
    {% if page_obj.has_previous %}
    <a href="?page={{ page_obj.previous_page_number }}&q={{ search_query }}&access={{ selected_access }}&sort={{ selected_sort }}"
       class="btn btn-sm btn-secondary"><i class="fas fa-chevron-right"></i></a>
    {% endif %}
    <span class="pagination-info">صفحه {{ page_obj.number }} از {{ page_obj.paginator.num_pages }}</span>
    {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}&q={{ search_query }}&access={{ selected_access }}&sort={{ selected_sort }}"
       class="btn btn-sm btn-secondary"><i class="fas fa-chevron-left"></i></a>
    {% endif %}
</div>
{% endif %}

{% else %}
<div style="text-align:center;padding:48px 16px;color:var(--text-secondary);">
    <i class="fas fa-search" style="font-size:40px;margin-bottom:12px;display:block;opacity:.3;"></i>
    <p>کتابی یافت نشد.</p>
    {% if search_query or selected_access %}
    <a href="{% url 'books:books_by_category' category.slug %}"
       class="btn btn-primary btn-sm" style="margin-top:12px;">پاک کردن فیلترها</a>
    {% endif %}
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/books.js' %}"></script>
{% endblock %}