{% extends 'base.html' %}
{% load static %}

{% block title %}کتابخانه محبوب{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/books.css' %}">

<!-- HTMX 2 -->
<script src="https://unpkg.com/htmx.org@2.0.4/dist/htmx.min.js"></script>


{% endblock %}

{% block content %}


{% if grouped_books %}
    {# حالت پیش‌فرض - گروه‌بندی بر اساس دسته‌بندی #}
    {% for cat, books in grouped_books.items %}
    <section class="book-category">
        <div class="section-header">
            <div class="section-title">
                {% if cat.icon %}<i class="{{ cat.icon }}"></i>{% else %}<i class="fas fa-book-open"></i>{% endif %}
                {{ cat.name }}
            </div>
            <a href="{% url 'books:books_by_category' cat.slug %}" class="view-all">
                مشاهده همه
                <i class="fas fa-chevron-left"></i>
            </a>
        </div>
        
        <div class="books-scroll">
            {% for book in books %}
            <a href="{% url 'books:book_detail' book.slug %}" class="book-card">
                <div class="book-cover">
                    {% if book.cover_image %}
                    <div class="book-image" style="background: #f5f5f5;">
                        <img src="{{ book.cover_image.url }}" 
                             alt="{{ book.title }}"
                             style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">
                    </div>
                    {% else %}
                    <div class="book-image" style="background: {% cycle 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)' 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)' 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' 'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)' %}">
                        <i class="fas fa-{% cycle 'quran' 'book-quran' 'mosque' 'book-reader' 'book' 'scroll' 'feather' 'book-open' %}"></i>
                    </div>
                    {% endif %}

                    {% if book.is_featured %}
                        <span class="book-badge">پرفروش</span>
                    {% elif book.access_type == 'free' %}
                        <span class="book-badge free">رایگان</span>
                    {% elif book.is_new %}
                        <span class="book-badge">جدید</span>
                    {% endif %}
                </div>

                <div class="book-info">
                    <h3 class="book-title">{{ book.title|truncatechars:20 }}</h3>
                    <p class="book-author">{{ book.author|truncatechars:15 }}</p>
                    <div class="book-meta">
                        <span class="book-pages">
                            <i class="fas fa-file-alt"></i>
                            {{ book.total_pages|default:'۲۰۰' }} صفحه
                        </span>
                        <span class="book-rating">
                            <i class="fas fa-star"></i>
                            {{ book.rating|default:'۴.۸' }}
                        </span>
                    </div>
                    <div class="book-price {% if book.access_type == 'free' %}free{% endif %}">
                        {% if book.access_type == 'free' %}
                            رایگان
                        {% elif book.discount_percent %}
                            <span style="text-decoration:line-through;font-size:10px;opacity:.6;">
                                {{ book.price|floatformat:0 }}
                            </span>
                            {{ book.final_price|floatformat:0 }} تومان
                        {% else %}
                            {{ book.price|floatformat:0|default:'۱۰۰,۰۰۰' }} تومان
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
    {% endfor %}

{% elif flat_books %}
    {# حالت جستجو / فیلتر — نمایش نتایج #}
    <section class="book-category">
        <div class="section-header">
            <div class="section-title">
                <i class="fas fa-search"></i>
                نتایج جستجو
            </div>
        </div>
        
        <div class="books-scroll">
            {% for book in flat_books %}
            <a href="{% url 'books:book_detail' book.slug %}" class="book-card">
                <div class="book-cover">
                    {% if book.cover_image %}
                    <div class="book-image" style="background: #f5f5f5;">
                        <img src="{{ book.cover_image.url }}" 
                             alt="{{ book.title }}"
                             style="width:100%;height:100%;object-fit:cover;border-radius:inherit;">
                    </div>
                    {% else %}
                    <div class="book-image" style="background: {% cycle 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' 'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)' 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)' 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' 'linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)' %}">
                        <i class="fas fa-{% cycle 'quran' 'book-quran' 'mosque' 'book-reader' 'book' 'scroll' 'feather' 'book-open' %}"></i>
                    </div>
                    {% endif %}

                    {% if book.is_featured %}
                        <span class="book-badge">پرفروش</span>
                    {% elif book.access_type == 'free' %}
                        <span class="book-badge free">رایگان</span>
                    {% elif book.is_new %}
                        <span class="book-badge">جدید</span>
                    {% endif %}
                </div>

                <div class="book-info">
                    <h3 class="book-title">{{ book.title|truncatechars:20 }}</h3>
                    <p class="book-author">{{ book.author|truncatechars:15 }}</p>
                    <div class="book-meta">
                        <span class="book-pages">
                            <i class="fas fa-file-alt"></i>
                            {{ book.total_pages|default:'۲۰۰' }} صفحه
                        </span>
                        <span class="book-rating">
                            <i class="fas fa-star"></i>
                            {{ book.rating|default:'۴.۸' }}
                        </span>
                    </div>
                    <div class="book-price {% if book.access_type == 'free' %}free{% endif %}">
                        {% if book.access_type == 'free' %}
                            رایگان
                        {% elif book.discount_percent %}
                            <span style="text-decoration:line-through;font-size:10px;opacity:.6;">
                                {{ book.price|floatformat:0 }}
                            </span>
                            {{ book.final_price|floatformat:0 }} تومان
                        {% else %}
                            {{ book.price|floatformat:0|default:'۱۰۰,۰۰۰' }} تومان
                        {% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </section>

    {# Pagination #}
    {% if flat_books.has_other_pages %}
    <div class="pagination-bar">
        {% if flat_books.has_previous %}
        <button class="btn-pagination"
                hx-get="{% url 'books:books_partial' %}?page={{ flat_books.previous_page_number }}"
                hx-target="#books-container"
                hx-include="#filter-form">
            <i class="fas fa-chevron-right"></i>
        </button>
        {% endif %}

        <span class="pagination-info">
            صفحه {{ flat_books.number }} از {{ flat_books.paginator.num_pages }}
        </span>

        {% if flat_books.has_next %}
        <button class="btn-pagination"
                hx-get="{% url 'books:books_partial' %}?page={{ flat_books.next_page_number }}"
                hx-target="#books-container"
                hx-include="#filter-form">
            <i class="fas fa-chevron-left"></i>
        </button>
        {% endif %}
    </div>
    {% endif %}

{% else %}
    <div class="empty-state">
        <i class="fas fa-search empty-icon"></i>
        <p class="empty-text">کتابی یافت نشد.</p>
    </div>
{% endif %}


{% endblock %}

{% block extra_js %}
<script src="{% static 'js/books.js' %}"></script>
{% endblock %}