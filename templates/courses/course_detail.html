{% extends 'base.html' %}
{% load static %}

{% block title %}{{ course.title }} | نگاره محبوب{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/courses.css' %}">
<style>
.section-block{background:var(--card-bg);border-radius:var(--radius-lg);margin-bottom:10px;border:1px solid var(--gray-200);overflow:hidden;}
.section-header-btn{width:100%;padding:16px;display:flex;align-items:center;justify-content:space-between;background:none;border:none;cursor:pointer;font-family:Vazirmatn,sans-serif;color:var(--text-primary);font-weight:600;font-size:15px;}
.section-header-btn:hover{background:var(--gray-50);}
.lesson-item{display:flex;align-items:center;gap:12px;padding:12px 20px;border-top:1px solid var(--gray-100);text-decoration:none;color:inherit;transition:all .2s;}
.lesson-item:hover{background:var(--gray-50);}
.lesson-type-icon{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:14px;}
.lesson-type-video{background:#e3f2fd;color:#1565c0;}
.lesson-type-audio{background:#fff3e0;color:#e65100;}
.lesson-type-pdf{background:#fce4ec;color:#c62828;}
.lesson-type-text{background:#f3e5f5;color:#6a1b9a;}
.lesson-type-quiz{background:#e8f5e9;color:#2e7d32;}
</style>
{% endblock %}

{% block content %}

<!-- هدر دوره -->
<div style="background:var(--card-bg);border-radius:var(--radius-xl);overflow:hidden;box-shadow:var(--shadow-xl);margin-bottom:20px;border:1px solid var(--gray-200);">
    <div style="position:relative;height:220px;">
        {% if course.cover_image %}
        <img src="{{ course.cover_image.url }}" alt="{{ course.title }}" style="width:100%;height:100%;object-fit:cover;">
        {% else %}
        <div style="width:100%;height:100%;background:{{ course.gradient }};display:flex;align-items:center;justify-content:center;">
            <i class="fas fa-{{ course.cover_icon }}" style="font-size:80px;color:rgba(255,255,255,.3);"></i>
        </div>
        {% endif %}
        {% if first_lesson and has_access %}
        <a href="{% url 'courses:lesson_view' course.slug first_lesson.pk %}"
           style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.3);">
            <div style="width:72px;height:72px;border-radius:50%;background:rgba(255,255,255,.95);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 16px rgba(0,0,0,.3);">
                <i class="fas fa-play" style="font-size:28px;color:var(--primary);margin-right:4px;"></i>
            </div>
        </a>
        {% elif first_lesson and first_lesson.is_preview %}
        <a href="{% url 'courses:lesson_view' course.slug first_lesson.pk %}"
           style="position:absolute;bottom:12px;right:12px;background:rgba(0,0,0,.7);color:white;padding:8px 16px;border-radius:8px;font-size:13px;text-decoration:none;">
            <i class="fas fa-play"></i> پیش‌نمایش رایگان
        </a>
        {% endif %}
    </div>
    <div style="padding:20px;">
        <h1 style="font-size:20px;font-weight:700;color:var(--text-primary);margin-bottom:8px;">{{ course.title }}</h1>
        <p style="font-size:14px;color:var(--text-secondary);margin-bottom:16px;">{{ course.short_desc }}</p>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px;font-size:13px;color:var(--text-secondary);">
            <span><i class="fas fa-user-tie" style="color:var(--primary);margin-left:6px;"></i>{{ course.instructor }}</span>
            <span><i class="fas fa-signal" style="color:var(--primary);margin-left:6px;"></i>{{ course.get_level_display }}</span>
            <span><i class="fas fa-play-circle" style="color:var(--primary);margin-left:6px;"></i>{{ course.lessons_count }} درس</span>
            <span><i class="fas fa-clock" style="color:var(--primary);margin-left:6px;"></i>{{ course.duration_display }}</span>
            <span><i class="fas fa-users" style="color:var(--primary);margin-left:6px;"></i>{{ course.enrollments }} دانش‌آموز</span>
            <span><i class="fas fa-star" style="color:#ffa726;margin-left:6px;"></i>{{ course.rating }} امتیاز</span>
        </div>
        {% if course.has_certificate %}
        <div style="background:#e8f5e9;border-radius:var(--radius);padding:10px 14px;font-size:13px;color:#2e7d32;margin-bottom:16px;">
            <i class="fas fa-certificate"></i> این دوره دارای گواهینامه پایان دوره است
        </div>
        {% endif %}
    </div>
</div>

<!-- دکمه خرید / ادامه -->
{% if not has_access and course.access_type != 'free' %}
<div style="background:var(--card-bg);border-radius:var(--radius-xl);padding:20px;margin-bottom:20px;border:1px solid var(--gray-200);box-shadow:var(--shadow);">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div>
            {% if course.discount_percent > 0 %}
            <del style="font-size:13px;color:var(--text-secondary);">{{ course.price|floatformat:0 }} تومان</del>
            {% endif %}
            <div style="font-size:22px;font-weight:700;color:var(--primary);">{{ course.final_price|floatformat:0 }} تومان</div>
        </div>
        {% if course.discount_percent > 0 %}
        <div style="background:var(--primary);color:white;padding:6px 14px;border-radius:12px;font-size:13px;font-weight:700;">
            {{ course.discount_percent }}% تخفیف
        </div>
        {% endif %}
    </div>
    {% if user.is_authenticated %}
    <form method="post" action="{% url 'purchase:start' 'course' course.pk %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary" style="width:100%;padding:16px;font-size:16px;display:flex;align-items:center;justify-content:center;gap:8px;">
            <i class="fas fa-shopping-cart"></i>
            خرید دوره — {{ course.final_price|floatformat:0 }} تومان
        </button>
    </form>
    {% else %}
    <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-primary" style="width:100%;padding:16px;font-size:16px;display:flex;align-items:center;justify-content:center;gap:8px;">
        <i class="fas fa-sign-in-alt"></i>
        ورود برای خرید
    </a>
    {% endif %}
</div>
{% elif has_access and first_lesson %}
<a href="{% url 'courses:lesson_view' course.slug first_lesson.pk %}" class="btn btn-primary" style="display:flex;align-items:center;justify-content:center;gap:8px;padding:16px;margin-bottom:20px;font-size:16px;">
    <i class="fas fa-play-circle"></i>
    ادامه یادگیری
</a>
{% endif %}

<!-- توضیحات -->
{% if course.description %}
<div style="background:var(--card-bg);border-radius:var(--radius-xl);padding:20px;margin-bottom:20px;border:1px solid var(--gray-200);">
    <h3 style="font-size:16px;font-weight:600;margin-bottom:12px;">
        <i class="fas fa-align-right" style="color:var(--primary);margin-left:8px;"></i>
        درباره دوره
    </h3>
    <p style="font-size:14px;line-height:1.8;color:var(--text-secondary);">{{ course.description }}</p>
</div>
{% endif %}

<!-- فهرست درس‌ها -->
{% if sections %}
<div style="margin-bottom:24px;">
    <h3 style="font-size:16px;font-weight:700;margin-bottom:12px;color:var(--text-primary);">
        <i class="fas fa-list" style="color:var(--primary);margin-left:8px;"></i>
        سرفصل‌های دوره
    </h3>
    {% for section in sections %}
    <div class="section-block">
        <button class="section-header-btn" onclick="toggleSection(this)">
            <span><i class="fas fa-layer-group" style="color:var(--primary);margin-left:8px;"></i> {{ section.title }}</span>
            <span style="font-size:12px;color:var(--text-secondary);">
                {{ section.lessons.count }} درس
                <i class="fas fa-chevron-down" style="margin-right:8px;transition:transform .2s;"></i>
            </span>
        </button>
        <div class="section-lessons" style="display:none;">
            {% for lesson in section.lessons.all %}
            {% if has_access or lesson.is_preview %}
            <a href="{% url 'courses:lesson_view' course.slug lesson.pk %}" class="lesson-item">
            {% else %}
            <div class="lesson-item" style="opacity:.6;cursor:default;">
            {% endif %}
                <div class="lesson-type-icon lesson-type-{{ lesson.lesson_type }}">
                    {% if lesson.lesson_type == 'video' %}<i class="fas fa-play"></i>
                    {% elif lesson.lesson_type == 'audio' %}<i class="fas fa-headphones"></i>
                    {% elif lesson.lesson_type == 'pdf' %}<i class="fas fa-file-pdf"></i>
                    {% elif lesson.lesson_type == 'text' %}<i class="fas fa-file-alt"></i>
                    {% else %}<i class="fas fa-question"></i>{% endif %}
                </div>
                <div style="flex:1;min-width:0;">
                    <div style="font-size:14px;font-weight:500;color:var(--text-primary);">{{ lesson.title }}</div>
                    <div style="font-size:12px;color:var(--text-secondary);">
                        {% with m=lesson.duration|divisibleby:60 %}
                        {{ lesson.duration|floatformat:0 }} ثانیه
                        {% endwith %}
                        {% if lesson.is_preview %}<span style="color:var(--success);margin-right:8px;font-size:11px;">رایگان</span>{% endif %}
                    </div>
                </div>
                {% if not has_access and not lesson.is_preview %}
                <i class="fas fa-lock" style="color:var(--gray-400);font-size:12px;"></i>
                {% endif %}
            {% if has_access or lesson.is_preview %}
            </a>
            {% else %}
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
function toggleSection(btn) {
    const list = btn.nextElementSibling;
    const icon = btn.querySelector('.fa-chevron-down');
    const open = list.style.display !== 'none';
    list.style.display = open ? 'none' : 'block';
    icon.style.transform = open ? '' : 'rotate(180deg)';
}
// باز کردن اولین سکشن
document.querySelectorAll('.section-header-btn')[0]?.click();
</script>
{% endblock %}